# ðŸš€ QUICK FIX COMMANDS FOR VPS 147.93.47.43
# Run these commands on your VPS to fix the 500 error

# Step 1: SSH into your VPS
ssh root@147.93.47.43

# Step 2: Check current status
pm2 status
systemctl status nginx
systemctl status postgresql

# Step 3: Check application logs
pm2 logs
tail -f /var/log/nginx/error.log

# Step 4: Navigate to project directory
cd /var/www/mybestlife/backend

# Step 5: Check if .env file exists
ls -la .env

# Step 6: If .env doesn't exist, create it
cat > .env << 'EOF'
# Database Configuration
DATABASE_URL="postgresql://mybestlife:secure_password_123@localhost:5432/mybestlife"

# JWT Security
JWT_SECRET="$(openssl rand -hex 64)"
JWT_REFRESH_SECRET="$(openssl rand -hex 64)"
JWT_EXPIRY="7d"
JWT_REFRESH_EXPIRY="30d"

# Email Configuration (UPDATE WITH YOUR CREDENTIALS)
SMTP_HOST="smtp.gmail.com"
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER="your-email@gmail.com"
SMTP_PASS="your-gmail-app-password"
SMTP_FROM_NAME="My Best Life"
SMTP_FROM_EMAIL="your-email@gmail.com"

# Application Configuration
NODE_ENV="production"
PORT=3000
FRONTEND_URL="https://mybestlifeapp.com"
API_BASE_URL="https://mybestlifeapp.com/api"

# Security Configuration
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
MIN_PASSWORD_LENGTH=8
REQUIRE_UPPERCASE=true
REQUIRE_LOWERCASE=true
REQUIRE_NUMBERS=true
REQUIRE_SYMBOLS=true
MAX_LOGIN_ATTEMPTS=5
LOCKOUT_DURATION_MINUTES=15
SESSION_SECRET="$(openssl rand -hex 32)"
COOKIE_SECURE=true
COOKIE_HTTP_ONLY=true
COOKIE_SAME_SITE="strict"

# SSL/TLS Configuration
FORCE_HTTPS=true

# Monitoring & Logging
LOG_LEVEL="info"
LOG_FILE_PATH="/var/log/mybestlife/app.log"
ENABLE_SECURITY_LOGGING=true
ENABLE_AUDIT_LOGGING=true
EOF

# Step 7: Install dependencies
npm install

# Step 8: Set up database
sudo -u postgres psql << 'EOF'
DROP DATABASE IF EXISTS mybestlife;
DROP USER IF EXISTS mybestlife;
CREATE DATABASE mybestlife;
CREATE USER mybestlife WITH PASSWORD 'secure_password_123';
GRANT ALL PRIVILEGES ON DATABASE mybestlife TO mybestlife;
\q
EOF

# Step 9: Generate database schema
npx prisma generate
npx prisma db push

# Step 10: Stop existing PM2 processes
pm2 delete all

# Step 11: Start the secure application
pm2 start app-secure.js --name mybestlife-secure
pm2 save

# Step 12: Check if application is running
pm2 status
curl http://localhost:3000/api/health

# Step 13: Fix SSL certificate (if needed)
certbot --nginx -d mybestlifeapp.com -d www.mybestlifeapp.com --email admin@mybestlifeapp.com --agree-tos --non-interactive --redirect

# Step 14: Test website
curl -k https://mybestlifeapp.com/api/health
